
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Micro iOs test</title>
    <link href="style.css" rel="stylesheet">
    <script src="https://tonejs.github.io/build/Tone.js"></script>
    <title>JavaScript Sensor Access Demo</title>
    
</head>
<body>
<main role="main" class="container">

<h1 align="left">Micro iOs test 5</h1>

<div class="p-3 mb-2 bg-secondary" id="demo-div">
<a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button">Start the demo</a>
<p style="margin-top:1rem;">Num. of datapoints: <span class="badge badge-warning" id="num-observed-events">0</span></p>


<h4 style="margin-top:0.75rem;">Orientation</h4>
<ul>
  <li>X-axis (&beta;): <span id="Orientation_b">0</span><span>&deg;</span></li>
  <li>Y-axis (&gamma;): <span id="Orientation_g">0</span><span>&deg;</span></li>
  <li>Z-axis (&alpha;): <span id="Orientation_a">0</span><span>&deg;</span></li>
</ul>

<h4>Accelerometer</h4>
<ul>
  <li>X-axis: <span id="Accelerometer_x">0</span><span> m/s<sup>2</sup></span></li>
  <li>Y-axis: <span id="Accelerometer_y">0</span><span> m/s<sup>2</sup></span></li>
  <li>Z-axis: <span id="Accelerometer_z">0</span><span> m/s<sup>2</sup></span></li>
  <li>Data Interval: <span id="Accelerometer_i">0</span><span> ms</span></li>
</ul>

<h4>Accelerometer including gravity</h4>

<ul>
  <li>X-axis: <span id="Accelerometer_gx">0</span><span> m/s<sup>2</sup></span></li>
  <li>Y-axis: <span id="Accelerometer_gy">0</span><span> m/s<sup>2</sup></span></li>
  <li>Z-axis: <span id="Accelerometer_gz">0</span><span> m/s<sup>2</sup></span></li>
</ul>

<h4>Gyroscope</h4>
<ul>
  <li>X-axis: <span id="Gyroscope_x">0</span><span>&deg;/s</span></li>
  <li>Y-axis: <span id="Gyroscope_y">0</span><span>&deg;/s</span></li>
  <li>Z-axis: <span id="Gyroscope_z">0</span><span>&deg;/s</span></li>
</ul>

<h4>Parameters from MICRO demo</h4>

<li>Pitch Wheel <span id="pitchwheel">0</span><span>&deg;</span></li>
<li>Filter Wheel <span id="filterwheel">0</span><span>&deg;</span></li>
<li>Harmonicity <span id="harmonicity">0</span><span>&deg;</span></li>
<li>X-axis: <span id="test_x">0</span></li>
<li>X-axis 2 test: <span id="test_x2">0</span></li><br>
<li>X-axis with filter: <span id="filter_x">0</span></li>
<li>Y-axis: <span id="test_y">0</span></li>
<li>Y-axis with filter: <span id="filter_y">0</span></li>
<li>Z-axis: <span id="test_z">0</span></li>
<li>Z-axis with filter: <span id="filter_z">0</span></li>
<li>Total acc: <span id="total_acc">0</span></li>
<li>Total filter: <span id="total_filter">0</span></li>
<li>Difference: <span id="diff_acc">0</span></li>


</div>

<button id="button1">Synth: OFF</button><br>

</main>
<footer class="footer">
 
</footer>
<script>

////////////////// Functions for scaling:

// With this function the values won't go below a threshold 
function clamp(min, max, val) {
  return Math.min(Math.max(min, +val), max);
}

//Scaling any incoming number
function generateScaleFunction(prevMin, prevMax, newMin, newMax) {
var offset = newMin - prevMin,
    scale = (newMax - newMin) / (prevMax - prevMin);
  return function (x) {
      return offset + scale * x;
      };
};
////////////////////////////

// orientation handling
function handleOrientation(event) {
  updateFieldIfNotNull('Orientation_a', event.alpha);
  updateFieldIfNotNull('Orientation_b', event.beta);
  updateFieldIfNotNull('Orientation_g', event.gamma);

  let pitchWheel = event.beta;
  let filterWheel = event.gamma;

  updateFieldIfNotNull('pitchwheel', pitchWheel);
  updateFieldIfNotNull('filterwheel', filterWheel);

  let harmonicity = pitchWheel / 180;
  updateFieldIfNotNull('harmonicity', harmonicity);
  synth.harmonicity.value = harmonicity;

  incrementEventCount();
}

function incrementEventCount(){
  let counterElement = document.getElementById("num-observed-events")
  let eventCount = parseInt(counterElement.innerHTML)
  counterElement.innerHTML = eventCount + 1;
}

function updateFieldIfNotNull(fieldName, value, precision=2){
  if (value != null)
    document.getElementById(fieldName).innerHTML = value.toFixed(precision);
}

let myVar = [];
var i = 0;

function handleMotion(event) {

    i += 1;
    console.log(i);
    console.log(event.acceleration.x);
    console.log(typeof event.acceleration.x);


myVar.push(event.acceleration.x);
console.log(myVar[1]);

  const accl = event.acceleration; 

  // LowPassFilterData(reading, bias) To be able to calcualte the difference between Accelerometer frames
  class LowPassFilterData {
  constructor(reading) {
    Object.assign(this, { x: reading.x, y: reading.y, z: reading.z });
  }
  
    update(reading) {
      this.x = reading.x;
      this.y = reading.y;
      this.z = reading.z;
    }
  };
  const filter = new LowPassFilterData(accl);
 // console.log(accl.z);
  //console.log(accl.z);
 // console.log("Hello");
//setTimeout(() => {  console.log(accl.z); }, 20);
  //console.log(accl.x);

  let xValue = accl.x;
  let yValue = accl.y;
  let zValue = accl.z;
  let xFilter = filter.x;
  let yFilter = filter.y;
  let zFilter = filter.z;
  let totAcc = Math.sqrt((xValue ** 2) + (yValue ** 2) + (zValue ** 2));
  let totFilter = Math.sqrt((xFilter ** 2) + (yFilter ** 2) + (zFilter ** 2));
  let diffAcc = (Math.abs(totAcc - totFilter)) * 10;

  updateFieldIfNotNull('test_x', accl.x );
//  setTimeout(() => {    updateFieldIfNotNull('test_x2', accl.x ); }, 20);
  //let xValue_prevFrame = document.getElementById('test_x');
  //let diffAcc = xValue - xValue_prevFrame;
  //console.log(xValue);
  //console.log(xValue_prevFrame);


  updateFieldIfNotNull('filter_x', filter.x );

  updateFieldIfNotNull('test_y', accl.y );
  updateFieldIfNotNull('filter_y', filter.y );

  updateFieldIfNotNull('test_z', accl.z );
  updateFieldIfNotNull('filter_z', filter.z );

  updateFieldIfNotNull('total_acc', totAcc );
  updateFieldIfNotNull('total_filter', totFilter );
  updateFieldIfNotNull('diff_acc', diffAcc );


  updateFieldIfNotNull('Accelerometer_gx', event.accelerationIncludingGravity.x);
  updateFieldIfNotNull('Accelerometer_gy', event.accelerationIncludingGravity.y);
  updateFieldIfNotNull('Accelerometer_gz', event.accelerationIncludingGravity.z);

  updateFieldIfNotNull('Accelerometer_x', event.acceleration.x);
  updateFieldIfNotNull('Accelerometer_y', event.acceleration.y);
  updateFieldIfNotNull('Accelerometer_z', event.acceleration.z);

  updateFieldIfNotNull('Accelerometer_i', event.interval, 2);

  updateFieldIfNotNull('Gyroscope_z', event.rotationRate.alpha);
  updateFieldIfNotNull('Gyroscope_x', event.rotationRate.beta);
  updateFieldIfNotNull('Gyroscope_y', event.rotationRate.gamma);
  incrementEventCount();
}



let is_running = false;
let demo_button = document.getElementById("start_demo");
demo_button.onclick = function(e) {
  e.preventDefault();
  
  // Request permission for iOS 13+ devices
  if (
    DeviceMotionEvent &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    DeviceMotionEvent.requestPermission();
  }
  
  if (is_running){
    window.removeEventListener("devicemotion", handleMotion);
    window.removeEventListener("deviceorientation", handleOrientation);
    demo_button.innerHTML = "Start demo";
    demo_button.classList.add('btn-success');
    demo_button.classList.remove('btn-danger');
    is_running = false;
  }else{
    window.addEventListener("devicemotion", handleMotion);
    window.addEventListener("deviceorientation", handleOrientation);
    document.getElementById("start_demo").innerHTML = "Stop demo";
    demo_button.classList.remove('btn-success');
    demo_button.classList.add('btn-danger');
    is_running = true;
  }
};




// Audio variables:

const synth = new Tone.AMSynth().toDestination();


document.getElementById("button1").addEventListener("click", function(){
   
    
   if(this.className == 'is-playing'){
     this.className = "";
     this.innerHTML = "Synth: OFF"
     synth.triggerRelease();
 
   }else{
     this.className = "is-playing";
     this.innerHTML = "Synth: ON";
     synth.triggerAttack("C4"); 
     
 
   }}
   );

</script>
</body>
</html>
